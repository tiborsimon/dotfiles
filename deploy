#!/bin/bash
#
# This script will install the full configuration of the tiborsimon/dotfiles repo.
# It will use a symlinked solution: it will symlink the configuration files located in
# the .dotfiles folder's subfolders. With this approach, you will be able to separate
# the configurations from each others.
#
# This script can be used if you already have cloned the dotfiles repo, but you want to update
# to the latest version.
#
# To be able to use this file, you have to fill out the global variables below.
#
# Usage: run the script from the ~/.dotfiles folder.

#set -e
source utils/commons

#----------------------------------------------------------------------------------------
#  F U N C T I O N S
#----------------------------------------------------------------------------------------

install_dotfiles () {
  info 'Installing dotfiles..'
  local overwrite_all=false backup_all=false skip_all=false
  for src in $(find -H "$HOME/.dotfiles/home" -mindepth 1 -maxdepth 1); do
    dst="$HOME/$(basename "${src}")"
    link_file "$src" "$dst"
  done
}


install_node_js () {
  while true; do
    user "Do you want to install Node.js and the essential npm tools? [${BoldGreen}y${ResetColor}]es, [${BoldGreen}s${ResetColor}]kip"
    read -n 1 action
    case "$action" in
      y ) info "Installing Node.js and essential tools with it.."
        which node > /dev/null
        if [[ $? != 0 ]]; then
          curl -sL https://deb.nodesource.com/setup_6.x | sudo -E bash -
          sudo apt-get install -y nodejs
          success 'Node.js installed!'
          info 'Installing global Node.js packages..'
          sudo npm install --silent -g local-web-server
          info 'Global Node.js packages installed!'
        else
          warning 'Node.js was already installed.. Nothing to do.'
        fi
        break
        ;;
      s ) success 'Skipped..'
        break
        ;;
      * ) warning "Wrong answer! Type ${BoldGreen}y${ResetColor} or ${BoldGreen}s${ResetColor}."
        ;;
    esac
  done
}

clone_essential_projects () {
  while true; do
    user "Do you want to clone the essential repositories?  [${BoldGreen}y${ResetColor}]es, [${BoldGreen}s${ResetColor}]kip"
    read -n 1 action
    case "$action" in
      y ) info 'Cloning essential repositories..'
        if [ ! -d ~/projects ]; then
          mkdir ~/projects
        fi
        if [ ! -d ~/projects/notebook ]; then
          git clone --depth 1 git@github.com:tiborsimon/notebook.git ~/projects/notebook
        fi
        if [ ! -d ~/projects/worklog ]; then
          git clone --depth 1 git@github.com:tiborsimon/worklog.git ~/projects/worklog
        fi
        if [ ! -d ~/projects/site ]; then
          git clone --depth 1 git@github.com:tiborsimon/tiborsimon.io-core.git ~/projects/site
        fi
        success 'Essential repositories cloned.'
        break
        ;;
      s ) success 'Skipped..'
        break
        ;;
      * ) warning "Wrong answer! Type ${BoldGreen}y${ResetColor} or ${BoldGreen}s${ResetColor}."
        ;;
    esac
  done
}


#----------------------------------------------------------------------------------------
#  F U N C T I O N S   C A L L S
#----------------------------------------------------------------------------------------

install_dotfiles
success 'Dotfiles has been deployed.'
