#!/usr/bin/env bash
#
# bootstrap installs things.

DOTFILES_ROOT=$(pwd)

set -e

echo ''

source functions/commons

install_dotfiles () {
  info 'Installing dotfiles..'

  local overwrite_all=false backup_all=false skip_all=false

  for src in $(find -H "$DOTFILES_ROOT" -maxdepth 2 -name '*.symlink' -not -path '*.git*')
  do
    dst="$HOME/.$(basename "${src%.*}")"
    link_file "$src" "$dst"
  done
}


install_etc_files () {
  info 'Installing etc files..'

  local overwrite_all=false backup_all=false skip_all=false

  for src in $(find -H "$DOTFILES_ROOT" -maxdepth 2 -name '*.etc' -not -path '*.git*')
  do
    dst="/etc/$(basename "${src%.*}")"
    link_file "$src" "$dst"
  done
}

set_up_osx () {
  info 'Configuring OSX..'
  source osx/set-defaults.sh
  success 'OSX configured!'
}


install_homebrew () {
  if test ! $(which brew)
  then
    info "Installing Homebrew.."

    ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
  else
    success "Homebrew is installed!"
  fi
}

update_homebrew () {
  info "Updating Homebrew.."
  if brew update > brew-update.log
  then
    success "Homebrew is up-to-date!"
  else
    fail "Error during Homebrew update!"
  fi
}

excute_brewfile () {
  user "Do you want to execute the Brewfile to install all your programs? [y]es, [s]kip"
  read -n 1 action

  case "$action" in
    y )
    info "Executing Brewfile.."
    brew bundle -v > brew-install.log
    success "Brewfile executed. All apps are installed.";;
    * )
      ;;
  esac
}

link_atom_files () {
  local overwrite_all=false backup_all=false skip_all=false

  info "Installing Atom files"
  link_file "$DOTFILES_ROOT/atom/config.cson" "$HOME/.atom/config.cson"
  link_file "$DOTFILES_ROOT/atom/init.coffee" "$HOME/.atom/init.coffee"
  link_file "$DOTFILES_ROOT/atom/keymap.cson" "$HOME/.atom/keymap.cson"
  link_file "$DOTFILES_ROOT/atom/projects.cson" "$HOME/.atom/projects.cson"
  link_file "$DOTFILES_ROOT/atom/snippets.cson" "$HOME/.atom/snippets.cson"
  link_file "$DOTFILES_ROOT/atom/styles.less" "$HOME/.atom/styles.less"
  success "Atom files are installed"
}

install_atom_packages () {
  info "Installing Atom packages.."
  apm install --packages-file atom/package-list.txt > atom-package-setup.log
  success "Atom packages installed!"
}

install_dotfiles
install_etc_files
set_up_osx
install_homebrew
update_homebrew
excute_brewfile
link_atom_files
install_atom_packages


echo ''
echo '  All installed!'
