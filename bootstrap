#!/usr/bin/env bash
DOTFILES_ROOT=~/.dotfiles
DOTFILES_REPO=git@github.com:tiborsimon/dotfiles
USER_EMAIL=tibor@tiborsimon.io
GITHUB_USERNAME=tiborsimon
SSH_KEY=~/.ssh/id_rsa

#----------------------------------------------------------------------------------------
#  C O M M O N   F U N C T I O N S
#----------------------------------------------------------------------------------------

info () {
  printf "\r  [ \033[00;34m..\033[0m ] $1\n"
}

user () {
  printf "\r  [ \033[0;33m??\033[0m ] $1\n"
}

success () {
  printf "\r\033[2K  [ \033[00;32mOK\033[0m ] $1\n"
}

fail () {
  printf "\r\033[2K  [\033[0;31mFAIL\033[0m] $1\n"
}

#----------------------------------------------------------------------------------------
#  B O O T S T R A P   S C R I P T 
#----------------------------------------------------------------------------------------

echo ''
echo '---------------------------------------------------------------------------------'
echo "      T I B O R   S I M O N ' S   D O T F I L E   C O N F I G U R A T I O N"
echo '---------------------------------------------------------------------------------'
echo ''

info 'Installing dotfiles system..'

if [ -d "$DOTFILES_ROOT" ]; then
  user "$DOTFILES_ROOT folder already exist. [D]elete, [a]bort"
  read -n 1 action

  case "$action" in
  D ) success "Old $DOTFILES_ROOT folder deleted."
      rm -rf $DOTFILES_ROOT
      ;;
  * ) success 'Bootstrap script aborted.'
      echo ''
      exit
      ;;
  esac
fi

info 'Looking for SSH key..'

if [ -f $SSH_KEY ] && [ -f $SSH_KEY.pub ]; then 
  user 'SSH key is detected. Do you want to create a new one? [C]reate, [k]eep'
  read -n 1 action

  case "$action" in
  C ) info 'Generating SSH key..'
      until ssh-keygen -t rsa -b 4096 -C "$USER_EMAIL" -f $SSH_KEY; do fail 'Key generation failed. Try again..'; done
      success 'SSH key generated.'
      ;;
  * ) success 'SSH key generation skipped. Existing key will be used.'
      ;;
  esac
else
  user "SSH key ($SSH_KEY) cannot be found. Generating a new one.."
  until ssh-keygen -t rsa -b 4096 -C "$USER_EMAIL" -f $SSH_KEY; do fail 'Key generation failed. Try again..'; done
  success 'SSH key generated.'
fi

user 'Do you want to add the SSH key to your GitHub account? [Y]es [s]kip'
read -n 1 action
case "$action" in
Y ) info "Uploading SSH key to $GITHUB_USERNAME's GitHub account.."
    curl -u "$GITHUB_USERNAME" --data "{\"title\":\"$(id -un)@$(hostname -f)\",\"key\":\"$(cat $SSH_KEY.pub)\"}" https://api.github.com/user/keys
    ;;
* ) info 'Skipped uploading SSH key to GitHub.'
    ;;
esac

if [ ! $(which git) ]; then
  fail 'Could not find git. You have to install it manually!'
  echo ''
  exit
fi

info 'Cloning dotfiles repository..'

git clone --quiet --depth 1 $DOTFILES_REPO $DOTFILES_ROOT>/dev/null 2>&1

success 'Dotfiles repository cloned.'
info 'Running deploy script..'

cd $DOTFILES_ROOT
./deploy

success 'Bootstrap script has finished!'
echo ''

